# Qdrant 构建说明

## 前置要求

### 1. 安装 Rust

Qdrant 使用 Rust 编写，需要先安装 Rust 工具链。

#### macOS

```bash
# 使用 rustup 安装（推荐）
curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh

# 或者使用 Homebrew
brew install rust
```

#### Linux

```bash
# 使用 rustup 安装（推荐）
curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh

# 或者使用包管理器（Ubuntu/Debian）
sudo apt-get update
sudo apt-get install rustc cargo
```

安装后，需要重新加载环境变量：

```bash
source ~/.cargo/env
```

验证安装：

```bash
rustc --version
cargo --version
```

### 2. 安装 Protocol Buffers 编译器

Qdrant 使用 Protocol Buffers 进行 gRPC 通信，需要安装 `protoc`。

#### macOS

```bash
brew install protobuf
```

#### Linux

```bash
# Ubuntu/Debian
sudo apt-get install protobuf-compiler

# 或者从源码安装
PROTOC_VERSION=22.2
PKG_NAME=$(uname -s | awk '{print ($1 == "Darwin") ? "osx-universal_binary" : (($1 == "Linux") ? "linux-x86_64" : "")}')

curl -LO https://github.com/protocolbuffers/protobuf/releases/download/v$PROTOC_VERSION/protoc-$PROTOC_VERSION-$PKG_NAME.zip
unzip protoc-$PROTOC_VERSION-$PKG_NAME.zip -d $HOME/.local
export PATH="$PATH:$HOME/.local/bin"
```

### 3. 安装其他依赖（Linux）

```bash
sudo apt-get update -y
sudo apt-get install -y curl unzip gcc-multilib clang cmake jq
```

## 构建方法

### 方法 1: 使用构建脚本（推荐）

```bash
# 构建 Release 版本（优化版本，用于生产环境）
./build.sh release

# 构建 Debug 版本（开发版本，包含调试信息）
./build.sh debug
```

### 方法 2: 直接使用 Cargo

```bash
# Release 版本（推荐用于生产环境）
cargo build --release

# Debug 版本（用于开发和调试）
cargo build
```

### 方法 3: 使用 Docker（无需安装 Rust）

```bash
# 构建 Docker 镜像
docker build . --tag=qdrant/qdrant

# 运行容器
docker run -p 6333:6333 qdrant/qdrant
```

## 构建选项

### 启用特定功能

```bash
# 启用 GPU 支持（NVIDIA）
cargo build --release --features gpu

# 启用 GPU 支持（AMD）
cargo build --release --features gpu

# 启用调试功能
cargo build --release --features service_debug

# 启用追踪功能
cargo build --release --features tracing
```

### 优化构建

```bash
# 针对当前 CPU 优化
RUSTFLAGS="-C target-cpu=native" cargo build --release

# 使用链接时优化（LTO）
# 已在 Cargo.toml 中默认启用
cargo build --release
```

## 构建输出

构建成功后，可执行文件位于：

- **Release 版本**: `target/release/qdrant`
- **Debug 版本**: `target/debug/qdrant`

## 运行

### 基本运行

```bash
# 使用默认配置
./target/release/qdrant

# 使用自定义配置文件
./target/release/qdrant --config-path config/config.yaml
```

### 集群模式运行

```bash
# 第一个节点
./target/release/qdrant --uri 'http://node1:6335'

# 其他节点（加入集群）
./target/release/qdrant --bootstrap 'http://node1:6335' --uri 'http://node2:6335'
```

## 常见问题

### 1. 构建时间过长

Qdrant 是一个大型项目，首次构建可能需要 10-30 分钟，这是正常的。后续构建会更快（增量编译）。

### 2. 内存不足

如果遇到内存不足错误，可以：

```bash
# 减少并行编译任务数
CARGO_BUILD_JOBS=2 cargo build --release
```

### 3. 网络问题（下载依赖失败）

如果在中国大陆，可能需要配置 Rust 镜像源。编辑 `~/.cargo/config`：

```toml
[source.crates-io]
replace-with = 'ustc'

[source.ustc]
registry = "https://mirrors.ustc.edu.cn/crates.io-index"
```

### 4. 缺少系统依赖

确保已安装所有必需的系统库。在 macOS 上，可能需要：

```bash
xcode-select --install
```

在 Linux 上，确保安装了开发工具：

```bash
sudo apt-get install build-essential
```

## 性能优化建议

1. **使用 Release 构建**：Release 版本经过优化，性能比 Debug 版本好得多
2. **启用 LTO**：已在 Cargo.toml 中默认启用链接时优化
3. **针对 CPU 优化**：使用 `target-cpu=native` 针对当前 CPU 优化
4. **使用 SSD**：将存储路径放在 SSD 上以提高性能

## 验证构建

构建完成后，可以验证可执行文件：

```bash
# 检查文件大小
ls -lh target/release/qdrant

# 检查版本信息
./target/release/qdrant --version

# 运行健康检查（需要先启动服务）
curl http://localhost:6333/health
```

## 更多信息

- 开发文档: [docs/DEVELOPMENT.md](docs/DEVELOPMENT.md)
- 快速开始: [docs/QUICK_START.md](docs/QUICK_START.md)
- 官方文档: https://qdrant.tech/documentation/
